
<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å°å­¦ç”Ÿç«–å¼ä¹˜é™¤æ³•è®¡ç®—å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style type="text/tailwindcss">
      @layer utilities {
        /* ä¹˜æ³•æ ¸å¿ƒæ ·å¼ */
        .multiplication-vertical {
          font-family: "Caveat", cursive;
          font-size: 1.8rem;
          line-height: 1.8;
          display: inline-block;
          position: relative;
          padding-left: 20px;
        }
        .multiplicand-digit,
        .multiplier-digit {
          display: inline-block;
          width: 40px;
          text-align: right;
          position: relative;
        }
        .multiplication-vertical .carry {
          position: absolute;
          left: calc(5px - (var(--position) * 40px));
          bottom: -50px;
          color: #ff4d4f;
          font-weight: bold;
          font-size: 1rem;
          opacity: 0;
          transform: translateY(10px);
          transition: all 0.5s ease;
        }
        .multiplication-vertical .carry.visible {
          opacity: 1;
          transform: translateY(0);
        }
        /* ä¹˜æ³•æ¨ªçº¿æ ·å¼ */
        .multiplication-line {
          border-bottom: 2px solid #165dff;
          margin: 8px 0;
          width: 0;
          margin-left: auto;
          margin-right: auto;
          transition: width 0.3s ease;
        }
        /* åŠ¨æ€éƒ¨åˆ†ç§¯æ ·å¼ */
        .partial-product {
          margin-left: calc(
            var(--single-digit-width) * var(--digit-offset) * -2
          );
          letter-spacing: calc(var(--single-digit-width) * 0.6);
          opacity: 0;
          transform: translateY(10px);
          transition: all 0.5s ease;
        }
        .partial-product.visible {
          opacity: 1;
          transform: translateY(0);
        }
        /* ä¹˜æ³•ç»“æœæ ·å¼ */
        .multiplication-result {
          margin-left: calc(var(--result-offset) * 1px);
          font-weight: bold;
          letter-spacing: 25px;
          padding-right: 20px;
          opacity: 0;
          transition: opacity 0.5s ease 0.3s;
          color: #165dff;
        }
        .multiplication-result.visible {
          opacity: 1;
        }
        /* é™¤æ³•æ ·å¼ */
        .division-bar {
          position: relative;
          display: inline-block;
          padding-left: 24px;
        }
        .division-bar::before {
          content: "";
          position: absolute;
          top: 0;
          left: 12px;
          width: 2px;
          height: 100%;
          background: #52c41a;
        }
        .division-bar::after {
          content: "";
          position: absolute;
          top: 0;
          left: 12px;
          width: calc(150%);
          height: 2px;
          background: #52c41a;
        }
        .carry-digit {
          color: #ff4d4f;
          font-weight: bold;
        }
        .divisor {
          position: absolute;
          left: -20px;
          top: 0;
          line-height: 1;
        }
        .full-dividend {
          position: relative;
          z-index: 10;
        }
        .group-2 {
          margin-left: 0.5rem;
        }
        .group-3 {
          margin-left: 1rem;
        }
        .group-4 {
          margin-left: 1.5rem;
        }

        /* å…¬å¼æ ‡ç­¾ */
        .formula-tag {
          cursor: pointer;
          padding: 4px 8px;
          border-radius: 4px;
          margin-right: 8px;
          transition: all 0.2s;
          display: inline-flex;
          align-items: center;
          gap: 4px;
          font-weight: 500;
        }
        .formula-tag.multiplication {
          background-color: #e6f7ff;
          color: #1890ff;
        }
        .formula-tag.multiplication:hover {
          background-color: #1890ff;
          color: white;
        }
        .formula-tag.division {
          background-color: #f6ffed;
          color: #52c41a;
        }
        .formula-tag.division:hover {
          background-color: #52c41a;
          color: white;
        }
        .formula-tag:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.5);
          z-index: 1000;
          justify-content: center;
          align-items: center;
          padding: 20px;
          backdrop-filter: blur(5px);
        }
        .modal-content {
          background-color: white;
          padding: 24px;
          border-radius: 12px;
          max-width: 90%;
          max-height: 90%;
          overflow-y: auto;
          box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
          transition: all 0.3s ease;
          transform: translateY(-20px);
          opacity: 0;
          min-width: 300px;
          max-width: 1000px;
        }
        @media (min-width: 768px) {
          .modal-content {
            min-width: 700px;
          }
          .formula-table {
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
          }
          .formula-item {
            height: 45px;
            font-size: 16px;
          }
        }
        .modal.active .modal-content {
          transform: translateY(0);
          opacity: 1;
        }
        .close-btn {
          float: right;
          font-size: 24px;
          cursor: pointer;
          padding: 0 8px;
          color: #666;
          transition: all 0.2s;
        }
        .close-btn:hover {
          color: #ff4d4f;
          transform: rotate(90deg);
        }

        /* å…¬å¼è¡¨æ ¼ */
        .formula-table {
          margin-top: 20px;
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
          gap: 8px;
        }
        .formula-item {
          height: 40px;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 6px;
          font-size: 15px;
          transition: all 0.2s;
          cursor: pointer;
          border: 1px solid transparent;
        }
        .formula-item:hover {
          transform: translateY(-1px);
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .formula-item.multiplication {
          background-color: #f0f7ff;
          border-left: 3px solid #1890ff;
        }
        .formula-item.multiplication:hover {
          background-color: #e6f7ff;
          border-color: #91d5ff;
        }
        .formula-item.division {
          background-color: #f6ffed;
          border-left: 3px solid #52c41a;
        }
        .formula-item.division:hover {
          background-color: #e6f7ff;
          border-color: #b7eb8f;
        }
        .formula-item .icon {
          margin-right: 6px;
          font-size: 12px;
        }

        /* å…¶ä»–æ ·å¼ */
        #vertical {
          text-align: center;
          margin: 0 auto;
          max-width: 90%;
          padding: 0 10px;
        }
        .modal-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          margin-bottom: 15px;
          border-bottom: 1px solid #e2e8f0;
          padding-bottom: 10px;
        }
        .modal-title {
          font-size: 20px;
          font-weight: bold;
          display: flex;
          align-items: center;
          gap: 8px;
        }
        .modal-title i {
          font-size: 22px;
        }
        .multiplication-title i {
          color: #1890ff;
        }
        .division-title i {
          color: #52c41a;
        }
        /* æŒ‰é’®æ ·å¼ */
        #calcBtn {
          transition: all 0.3s ease;
          transform: translateY(0);
        }
        #calcBtn:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(22, 93, 255, 0.3);
        }
        #calcBtn:active {
          transform: translateY(0);
        }
        /* è¾“å…¥æ¡†æ ·å¼ */
        input[type="number"] {
          transition: all 0.3s ease;
        }
        input[type="number"]:focus {
          border-color: #165dff;
          box-shadow: 0 0 0 2px rgba(22, 93, 255, 0.2);
          outline: none;
        }
        /* ç»“æœåŒºåŸŸ */
        #result {
          animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
          from {
            opacity: 0;
            transform: translateY(10px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }
        /* æ¨ç†è¿‡ç¨‹æ ·å¼ */
        #explanation {
          background-color: #f9fafb;
          padding: 1rem;
          border-radius: 8px;
          border-left: 3px solid #165dff;
        }
        #explanation h3 {
          color: #165dff;
        }
        #explanation li {
          transition: all 0.2s ease;
        }
        #explanation li:hover {
          color: #165dff;
          transform: translateX(3px);
        }
        /* é€‰æ‹©æ¡†æ ·å¼ */
        select#operator {
          color: #165dff;
          font-weight: bold;
          padding: 0 0.5rem;
        }
        /* å°å­¦ç”Ÿæç¤ºæ¨¡å— */
        .student-note {
          background-color: #fff8e6;
          border-left: 4px solid #faad14;
          padding: 12px 16px;
          margin-bottom: 1rem;
          border-radius: 4px;
          display: flex;
          align-items: center;
          gap: 10px;
        }
        .student-note i {
          color: #faad14;
          font-size: 1.2rem;
        }
        .student-note p {
          margin: 0;
          color: #854d27;
          font-size: 0.95rem;
        }
      }
    </style>
    <link
      href="https://fonts.googleapis.com/css2?family=Caveat:wght@500&display=swap"
      rel="stylesheet"
    />
  </head>
  <body
    class="bg-gradient-to-br from-blue-50 to-indigo-50 min-h-screen p-4 md:p-8"
  >
    <div
      class="max-w-4xl mx-auto bg-white p-6 md:p-8 rounded-xl shadow-lg transform transition-all duration-300 hover:shadow-xl"
    >
      <!-- å°å­¦ç”Ÿæç¤ºæ¨¡å— -->
      <div class="student-note">
        <i class="fas fa-lightbulb"></i>
        <p>
          ğŸ“š è¿™æ˜¯ä¸“ä¸ºå°å­¦ç”Ÿè®¾è®¡çš„æ•°å­¦å·¥å…·ï¼Œå¸®åŠ©ä½ å­¦ä¹ ä¹˜æ³•å’Œé™¤æ³•çš„ç«–å¼è®¡ç®—æ–¹æ³•ã€‚
        </p>
      </div>

      <!-- å£è¯€æ ‡ç­¾ -->
      <div class="mb-6">
        <span
          class="formula-tag multiplication"
          onclick="showModal('multiplication')"
        >
          <i class="fas fa-multiply"></i> ä¹˜æ³•å£è¯€
        </span>
        <span class="formula-tag division" onclick="showModal('division')">
          <i class="fas fa-divide"></i> é™¤æ³•å£è¯€
        </span>
      </div>

      <h1
        class="text-3xl md:text-4xl font-bold text-center mb-8 text-indigo-600 bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600"
      >
        å°å­¦ç”Ÿç«–å¼ä¹˜é™¤æ³•è®¡ç®—å™¨
      </h1>

      <!-- è¾“å…¥åŒºåŸŸ -->
      <div
        class="flex flex-wrap items-end gap-4 mb-8 p-6 bg-gray-50 rounded-lg"
      >
        <div style="width: 25%">
          <div id="num1Label" class="block text-gray-700 mb-1 font-medium">
            è¢«ä¹˜æ•°
          </div>
          <input
            type="number"
            id="num1"
            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200"
            placeholder="ä¾‹å¦‚ï¼š15"
          />
        </div>
        <div class="text-2xl font-bold">
          <select id="operator" class="border-none bg-transparent text-xl">
            <option value="multiply">Ã—</option>
            <option value="divide">Ã·</option>
          </select>
        </div>
        <div style="width: 25%">
          <div id="num2Label" class="block text-gray-700 mb-1 font-medium">
            ä¹˜æ•°
          </div>
          <input
            type="number"
            id="num2"
            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200"
            placeholder="ä¾‹å¦‚ï¼š12"
          />
        </div>
        <div>
          <button
            id="calcBtn"
            class="bg-indigo-600 text-white px-6 py-2.5 rounded-lg hover:bg-indigo-700 font-medium"
          >
            è®¡ç®—
          </button>
        </div>
      </div>

      <div
        id="error"
        class="hidden text-red-500 mb-6 p-3 bg-red-50 rounded-lg border border-red-100"
      ></div>

      <div id="result" class="hidden">
        <h2
          id="processTitle"
          class="text-xl font-semibold mb-4 pb-2 border-b border-gray-100"
        >
          ä¹˜æ³•è®¡ç®—è¿‡ç¨‹ï¼š
        </h2>
        <div
          id="vertical"
          class="mb-6 p-4 bg-gray-50 rounded-lg min-h-[150px] flex items-center justify-center"
        ></div>
        <div class="p-4 bg-gray-50 rounded-lg mb-4">
          <p class="text-lg">
            ç»“æœï¼š<span
              id="finalResult"
              class="font-semibold text-indigo-600 text-xl"
            ></span>
          </p>
        </div>
      </div>
    </div>

    <!-- ä¹˜æ³•å£è¯€å¼¹çª— -->
    <div id="multiplication-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title multiplication-title">
            <i class="fas fa-multiply"></i> ä¹˜æ³•å£è¯€è¡¨
          </h3>
          <span class="close-btn" onclick="hideModal('multiplication')"
            >&times;</span
          >
        </div>
        <div id="multiplication-table" class="formula-table"></div>
      </div>
    </div>

    <!-- é™¤æ³•å£è¯€å¼¹çª— -->
    <div id="division-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title division-title">
            <i class="fas fa-divide"></i> é™¤æ³•å£è¯€è¡¨
          </h3>
          <span class="close-btn" onclick="hideModal('division')">&times;</span>
        </div>
        <div id="division-table" class="formula-table"></div>
      </div>
    </div>

    <script>
      // ç”Ÿæˆä¹˜æ³•å£è¯€è¡¨
      function generateMultiplicationTable() {
        const table = document.getElementById("multiplication-table");
        table.innerHTML = "";
        for (let i = 1; i <= 9; i++) {
          for (let j = 1; j <= i; j++) {
            const item = document.createElement("div");
            item.className = "formula-item multiplication";
            item.innerHTML = `${j}Ã—${i}=${j * i}`;
            item.addEventListener("click", () => {
              document.getElementById("num1").value = j;
              document.getElementById("num2").value = i;
              document.getElementById("operator").value = "multiply";
              hideModal("multiplication");
              calc();
            });
            table.appendChild(item);
          }
        }
      }

      // ç”Ÿæˆé™¤æ³•å£è¯€è¡¨
      function generateDivisionTable() {
        const table = document.getElementById("division-table");
        table.innerHTML = "";

        const divisionData = [
          [1],
          [2, 4],
          [3, 6, 9],
          [4, 8, 12, 16],
          [5, 10, 15, 20, 25],
          [6, 12, 18, 24, 30, 36],
          [7, 14, 21, 28, 35, 42, 49],
          [8, 16, 24, 32, 40, 48, 56, 64],
          [9, 18, 27, 36, 45, 54, 63, 72, 81],
        ];

        divisionData.forEach((row, index) => {
          const divisor = index + 1;
          row.forEach((dividend) => {
            const item = document.createElement("div");
            item.className = "formula-item division";
            item.innerHTML = ` ${dividend}Ã·${divisor}=${dividend / divisor}`;
            item.addEventListener("click", () => {
              document.getElementById("num1").value = dividend;
              document.getElementById("num2").value = divisor;
              document.getElementById("operator").value = "divide";
              hideModal("division");
              calc();
            });
            table.appendChild(item);
          });
        });
      }

      // æ¨¡æ€æ¡†æ§åˆ¶
      function showModal(type) {
        const modal = document.getElementById(`${type}-modal`);
        modal.style.display = "flex";
        setTimeout(() => modal.classList.add("active"), 10);
      }
      function hideModal(type) {
        const modal = document.getElementById(`${type}-modal`);
        modal.classList.remove("active");
        setTimeout(() => (modal.style.display = "none"), 300);
      }
      window.onclick = function (event) {
        const modals = document.getElementsByClassName("modal");
        for (let i = 0; i < modals.length; i++) {
          if (event.target == modals[i]) {
            modals[i].classList.remove("active");
            setTimeout(() => (modals[i].style.display = "none"), 300);
          }
        }
      };

      // åŠ¨æ€åˆ‡æ¢è¾“å…¥æ¡†æ ‡ç­¾
      document
        .getElementById("operator")
        .addEventListener("change", function () {
          const num1Label = document.getElementById("num1Label");
          const num2Label = document.getElementById("num2Label");
          if (this.value === "multiply") {
            num1Label.textContent = "è¢«ä¹˜æ•°";
            num2Label.textContent = "ä¹˜æ•°";
          } else {
            num1Label.textContent = "è¢«é™¤æ•°";
            num2Label.textContent = "é™¤æ•°";
          }
        });

      // åˆå§‹åŒ–
      window.onload = function () {
        generateMultiplicationTable();
        generateDivisionTable();
      };

      // æ ¼å¼å¤„ç†
      function formatNumber(num) {
        if (Number.isInteger(num)) return num.toString();
        return num
          .toString()
          .replace(/(\.\d*?)0+$/, "$1")
          .replace(/\.$/, "");
      }

      // è®¡ç®—ä¹˜æ³•æ¨ªçº¿çš„åŠ¨æ€å®½åº¦
      function calculateMultiplicationLineWidth() {
        const verticalEl = document.getElementById("vertical");
        const targetElements = verticalEl.querySelectorAll(
          ".multiplicand-digit, .partial-product, .multiplication-result"
        );

        let maxWidth = 0;
        targetElements.forEach((el) => {
          const elementWidth = el.offsetWidth;
          if (elementWidth > maxWidth) {
            maxWidth = elementWidth;
          }
        });

        const dynamicWidth = Math.max(maxWidth + 60, 200);
        const lines = verticalEl.querySelectorAll(".multiplication-line");
        lines.forEach((line) => {
          line.style.width = `${dynamicWidth}px`;
        });
        return dynamicWidth;
      }

      // é€ä½æ˜¾ç¤ºä¹˜æ³•åŠ¨ç”»
      function animateMultiplicationSteps(data) {
        const { carryDetails, partProducts } = data;
        const verticalEl = document.getElementById("vertical");
        const lines = verticalEl.querySelectorAll(".multiplication-line");

        // æ˜¾ç¤ºç¬¬ä¸€æ¡æ¨ªçº¿
        setTimeout(() => {
          lines[0].style.width = calculateMultiplicationLineWidth() + "px";
        }, 1000);

        // é€ä¸ªæ˜¾ç¤ºéƒ¨åˆ†ç§¯å’Œå¯¹åº”çš„è¿›ä½ï¼ŒåŒæ—¶éšè—ä¸Šä¸€ä½çš„è¿›ä½
        carryDetails.forEach((carryDetail, index) => {
          setTimeout(() => {
            // éšè—ä¸Šä¸€ä½çš„è¿›ä½
            if (index > 0) {
              const prevCarryElements = verticalEl.querySelectorAll(
                `.carry[data-position="${index - 1}"]`
              );
              prevCarryElements.forEach((carry) => {
                carry.classList.remove("visible");
              });
            }

            // æ˜¾ç¤ºå½“å‰ä½çš„è¿›ä½
            const currentCarryElements = verticalEl.querySelectorAll(
              `.carry[data-position="${index}"]`
            );
            currentCarryElements.forEach((carry) => {
              carry.classList.add("visible");
            });

            // æ˜¾ç¤ºå½“å‰éƒ¨åˆ†ç§¯
            if (index < partProducts.length) {
              const partialProduct =
                verticalEl.querySelectorAll(".partial-product")[index];
              if (partialProduct) {
                partialProduct.classList.add("visible");
              }
            }

            // å¦‚æœæ˜¯æœ€åä¸€ä¸ªéƒ¨åˆ†ç§¯ï¼Œæ˜¾ç¤ºç¬¬äºŒæ¡æ¨ªçº¿å’Œç»“æœ
            if (index === carryDetails.length - 1) {
              setTimeout(() => {
                // æ–°å¢å»¶è¿Ÿï¼šè®©æœ€åä¸€æ¬¡è¿›ä½æ˜¾ç¤º5ç§’åå†éšè—
                setTimeout(() => {
                  const lastCarryElements = verticalEl.querySelectorAll(
                    `.carry[data-position="${index}"]`
                  );
                  lastCarryElements.forEach((carry) => {
                    carry.classList.remove("visible");
                  });
                }, 5000);

                // æ˜¾ç¤ºç¬¬äºŒæ¡æ¨ªçº¿
                if (lines.length > 1) {
                  lines[1].style.width =
                    calculateMultiplicationLineWidth() + "px";
                }

                // å»¶è¿Ÿæ˜¾ç¤ºæœ€ç»ˆç»“æœ
                setTimeout(() => {
                  verticalEl
                    .querySelector(".multiplication-result")
                    .classList.add("visible");
                }, 1000);
              }, 1000);
            }
          }, 3000 * (index + 1));
        });
      }

      // è®¡ç®—é€»è¾‘
      document.getElementById("calcBtn").addEventListener("click", calc);
      function calc() {
        const num1 = parseFloat(document.getElementById("num1").value);
        const num2 = parseFloat(document.getElementById("num2").value);
        const operator = document.getElementById("operator").value;
        const errorEl = document.getElementById("error");
        const resultEl = document.getElementById("result");
        const verticalEl = document.getElementById("vertical");
        const finalEl = document.getElementById("finalResult");
        const processTitle = document.getElementById("processTitle");

        // æ¸…ç©ºçŠ¶æ€
        errorEl.classList.add("hidden");
        resultEl.classList.add("hidden");
        const oldExplanation = document.getElementById("explanation");
        if (oldExplanation) oldExplanation.remove();

        // éªŒè¯
        if (isNaN(num1) || isNaN(num2)) {
          errorEl.textContent = "è¯·è¾“å…¥æœ‰æ•ˆæ•°å­—";
          errorEl.classList.remove("hidden");
          return;
        }
        if (operator === "divide" && num2 === 0) {
          errorEl.textContent = "é™¤æ•°ä¸èƒ½ä¸º0";
          errorEl.classList.remove("hidden");
          return;
        }

        // è®¡ç®—
        let steps, finalText, processHtml;
        if (operator === "multiply") {
          processTitle.textContent = "ä¹˜æ³•è®¡ç®—è¿‡ç¨‹ï¼š";
          steps = generateMultiplicationSteps(num1, num2);
          processHtml = renderMultiplicationVertical(num1, num2, steps);
          finalText = `${num1} Ã— ${num2} = ${formatNumber(steps.product)}`;
        } else {
          processTitle.textContent = "é™¤æ³•è®¡ç®—è¿‡ç¨‹ï¼š";
          steps = generateDivisionSteps(num1, num2);
          processHtml = renderDivisionVertical(num1, num2, steps);
          finalText = `${num1} Ã· ${num2} = ${formatNumber(steps.quotient)}`;
        }

        // æ¸²æŸ“ç»“æœ
        verticalEl.innerHTML = processHtml;
        finalEl.textContent = finalText;
        const resultContainer = finalEl.closest(".p-4.bg-gray-50.rounded-lg");
        let explanationHtml = `<div id="explanation" class="mt-4 text-sm md:text-base text-gray-700"><h3 class="font-semibold mb-2">æ¨ç†è¿‡ç¨‹ï¼š</h3><ul class="list-disc pl-5 space-y-2">`;
        steps.steps.forEach((step) => {
          step.explanation.forEach(
            (desc) => (explanationHtml += `<li>${desc}</li>`)
          );
        });
        explanationHtml += `</ul></div>`;
        resultContainer.insertAdjacentHTML("afterend", explanationHtml);
        resultEl.classList.remove("hidden");

        // å¯åŠ¨ä¹˜æ³•åŠ¨ç”»
        if (operator === "multiply") {
          setTimeout(() => {
            calculateMultiplicationLineWidth();
            animateMultiplicationSteps(steps);
          }, 500);
        }
      }

      // ä¹˜æ³•æ­¥éª¤ç”Ÿæˆ
      function generateMultiplicationSteps(num1, num2) {
        const getIntegerAndDigits = (num) => {
          const str = num.toString();
          const dotIndex = str.indexOf(".");
          if (dotIndex === -1) {
            return { integer: parseInt(str, 10), digits: 0 };
          }
          const digits = str.length - dotIndex - 1;
          const integerStr = str.replace(".", "");
          return { integer: parseInt(integerStr, 10), digits };
        };

        const { integer: int1, digits: d1 } = getIntegerAndDigits(num1);
        const { integer: int2, digits: d2 } = getIntegerAndDigits(num2);
        const totalDigits = d1 + d2;

        const steps = [];
        const num1Str = int1.toString();
        const num2Str = int2.toString();
        const partProducts = [];
        const carryDetails = [];
        let hasCarry = false;

        steps.push({
          explanation: [
            `è®¡ç®— ${num1} Ã— ${num2}ï¼Œå…ˆè½¬æ¢ä¸ºæ•´æ•°è®¡ç®—ï¼š${int1} Ã— ${int2}`,
            `è¢«ä¹˜æ•°ï¼š${num1Str}ï¼ˆåŸæ•°${num1}ï¼‰ï¼Œä¹˜æ•°ï¼š${num2Str}ï¼ˆåŸæ•°${num2}ï¼‰`,
          ],
        });

        for (let i = num2Str.length - 1; i >= 0; i--) {
          const digit2 = parseInt(num2Str[i], 10);
          let carry = 0;
          let partProduct = "";
          const stepExplanations = [
            `ç”¨ä¹˜æ•°çš„ç¬¬${
              num2Str.length - i
            }ä½ï¼ˆæ•°å­—${digit2}ï¼‰ä¹˜ä»¥è¢«ä¹˜æ•°çš„æ¯ä¸€ä½`,
          ];
          const digitCarries = [];

          for (let j = num1Str.length - 1; j >= 0; j--) {
            const digit1 = parseInt(num1Str[j], 10);
            const product = digit1 * digit2 + carry;
            const currentDigit = product % 10;
            carry = Math.floor(product / 10);
            partProduct = currentDigit + partProduct;
            digitCarries.push({ digit1, digit2, position: j, carry });
            stepExplanations.push(
              `${digit1} Ã— ${digit2} + è¿›ä½${
                carry === 0 ? "0" : carry
              } = ${product}ï¼Œå†™${currentDigit}ï¼Œè¿›ä½${carry}`
            );

            if (carry > 0) hasCarry = true;
          }

          if (carry > 0) {
            partProduct = carry + partProduct;
            stepExplanations.push(`æœ€åè¿›ä½${carry}ï¼Œç›´æ¥å†™ä¸‹`);
            hasCarry = true;
          }

          const partProductNum = parseInt(partProduct, 10);
          partProducts.push(partProductNum);
          carryDetails.push({
            digitPosition: num2Str.length - 1 - i,
            digitCarries,
            partProduct: partProductNum,
          });

          steps.push({
            digit2,
            partProduct: partProductNum,
            digitPosition: num2Str.length - 1 - i,
            digitCarries,
            explanation: stepExplanations,
          });
        }

        let integerProduct = partProducts.reduce(
          (sum, p, i) => sum + p * 10 ** i,
          0
        );
        const product = integerProduct / 10 ** totalDigits;

        steps.push({
          explanation: [
            `æ•´æ•°ä¹˜ç§¯ï¼š${integerProduct}ï¼Œæ€»å°æ•°ä½æ•°ï¼š${totalDigits}`,
            `è¿˜åŸç»“æœï¼š${integerProduct} Ã· 10^${totalDigits} = ${product}`,
            `æœ€ç»ˆç»“æœï¼š${num1} Ã— ${num2} = ${product}`,
          ],
        });

        return { steps, product, partProducts, carryDetails, hasCarry };
      }

      // ä¹˜æ³•ç«–å¼æ¸²æŸ“
      function renderMultiplicationVertical(num1, num2, data) {
        const { carryDetails, product, partProducts } = data;
        const num1Str = num1.toString();
        const num2Str = num2.toString();
        const int1Str = num1Str.replace(".", "");
        const int2Str = num2Str.replace(".", "");

        // è®¡ç®—æœ€å¤§ä½æ•°ä½œä¸ºå¯¹é½åŸºå‡†
        const maxDigitCount = Math.max(int1Str.length, int2Str.length);
        const multiplicandOffset = (maxDigitCount - int1Str.length) * 20 + 20;
        const multiplierOffset = (maxDigitCount - int2Str.length) * 20;

        // ç”Ÿæˆè¢«ä¹˜æ•°HTMLï¼ˆå¸¦è¿›ä½æ ‡è®°ï¼‰
        let num1Html = "";
        for (let i = 0; i < num1Str.length; i++) {
          const char = num1Str[i];
          if (char === ".") {
            num1Html += `<div class="multiplicand-digit">${char}</div>`;
            continue;
          }

          // ä¸ºæ¯ä¸€ä½æ•°å­—æ·»åŠ æ‰€æœ‰å¯èƒ½çš„è¿›ä½æ ‡è®°
          let carryHtml = "";
          carryDetails.forEach((carryDetail, index) => {
            const digitIndex = int1Str.indexOf(
              char,
              i - (num1Str.substring(0, i).includes(".") ? 1 : 0)
            );
            const carry =
              carryDetail.digitCarries.find((c) => c.position === digitIndex)
                ?.carry || 0;
            if (carry > 0) {
              carryHtml += `<span class="carry" data-position="${index}" style="--position: ${index}">${carry}</span>`;
            }
          });

          num1Html += `<div class="multiplicand-digit">${char}${carryHtml}</div>`;
        }

        // ç”Ÿæˆä¹˜æ•°HTML
        let num2Html = "";
        for (let i = 0; i < num2Str.length; i++) {
          const char = num2Str[i];
          if (char === ".") {
            num2Html += `<div class="multiplier-digit">${char}</div>`;
            continue;
          }
          num2Html += `<div class="multiplier-digit">${char}</div>`;
        }

        // éƒ¨åˆ†ç§¯æ¸²æŸ“
        let partialProductsHtml = "";
        if (carryDetails.length > 1) {
          carryDetails.forEach((item, index) => {
            const productStr = item.partProduct.toString();
            const paddedProduct = productStr.padStart(maxDigitCount, " ");
            partialProductsHtml += `<div class="partial-product" style="--digit-offset: ${index}">${paddedProduct}</div>`;
          });
        }

        // è®¡ç®—ç»“æœåç§»é‡
        const productStr = product.toString().replace(/\./, "");
        const resultOffset = (maxDigitCount - productStr.length) * 20;

        // è®¡ç®—å•ä¸ªæ•°å­—å®½åº¦å¹¶è®¾ç½®CSSå˜é‡
        setTimeout(() => {
          const singleDigitEl = document.querySelector(".multiplicand-digit");
          if (singleDigitEl) {
            const singleDigitWidth = singleDigitEl.offsetWidth;
            document.documentElement.style.setProperty(
              "--single-digit-width",
              `${singleDigitWidth}px`
            );
          }
        }, 0);

        return `
    <div class="multiplication-vertical">
      <div style="margin-left: ${multiplicandOffset}px">${num1Html}</div>
      <div style="margin-left: ${multiplierOffset}px">Ã—${num2Html}</div>
      <div class="multiplication-line"></div>
      ${partialProductsHtml}
      ${
        carryDetails.length > 1 ? '<div class="multiplication-line"></div>' : ""
      }
      <div class="multiplication-result" style="--result-offset: ${resultOffset}">${product.toString()}</div>
    </div>
  `;
      }

      // é™¤æ³•æ­¥éª¤ç”Ÿæˆ
      function generateDivisionSteps(dividend, divisor) {
        // æ–°å¢ï¼šå¤„ç†é™¤æ•°ä¸ºå°æ•°çš„æƒ…å†µï¼Œç»Ÿä¸€åŒ–ä¸ºæ•´æ•°è®¡ç®—
        const divisorStr = divisor.toString();
        const [divisorIntPart, divisorDecPart = ""] = divisorStr.split(".");
        const divisorDecimalCount = divisorDecPart.length; // é™¤æ•°çš„å°æ•°ä½æ•°
        const scale = Math.pow(10, divisorDecimalCount); // æ”¾å¤§å€æ•°

        // è¢«é™¤æ•°å’Œé™¤æ•°åŒæ—¶æ”¾å¤§ç›¸åŒå€æ•°ï¼Œç¡®ä¿é™¤æ•°å˜ä¸ºæ•´æ•°
        const scaledDividend = dividend * scale;
        const scaledDivisor = divisor * scale;

        // åç»­é€»è¾‘ä¸å˜ï¼Œä½†ä½¿ç”¨æ”¾å¤§åçš„æ•´æ•°ï¼ˆscaledDividendã€scaledDivisorï¼‰è®¡ç®—
        const steps = [];
        const quotientDigits = [];
        let remainder = 0;
        let hasDecimal = false;
        const maxDecimal = 6;
        let decimalCount = 0;

        const dividendStr = scaledDividend.toString();
        const [dividendIntPart, dividendDecPart = ""] = dividendStr.split(".");
        const intDigits = dividendIntPart.split("").map(Number);
        const decDigits = dividendDecPart.split("").map(Number);
        const totalDigits = intDigits.length + decDigits.length;
        let digitIndex = 0;

        let currentNum = 0;
        while (digitIndex < intDigits.length && currentNum < scaledDivisor) {
          currentNum = currentNum * 10 + intDigits[digitIndex];
          digitIndex++;
        }

        let firstDigit;
        if (currentNum >= scaledDivisor) {
          firstDigit = Math.floor(currentNum / scaledDivisor);
          quotientDigits.push(firstDigit);
        } else {
          firstDigit = 0;
          quotientDigits.push(0);
          if (digitIndex >= intDigits.length) {
            quotientDigits.push(".");
            hasDecimal = true;
          }
        }
        const firstProduct = firstDigit * scaledDivisor;
        remainder = currentNum - firstProduct;

        // æ–°å¢ï¼šåœ¨ç¬¬ä¸€æ­¥è¯´æ˜æ”¾å¤§é€»è¾‘ï¼Œå¸®åŠ©å°å­¦ç”Ÿç†è§£
        steps.push({
          minuend: currentNum,
          product: firstProduct,
          remainder: remainder,
          carryDigit: null,
          isOriginalDigit: false,
          explanation: [
            `è®¡ç®— ${dividend} Ã· ${divisor}ï¼Œå…ˆç»Ÿä¸€å°æ•°ä½æ•°ï¼š`,
            `é™¤æ•°æœ‰${divisorDecimalCount}ä½å°æ•°ï¼Œè¢«é™¤æ•°å’Œé™¤æ•°åŒæ—¶Ã—${scale}ï¼Œè½¬åŒ–ä¸º ${scaledDividend} Ã· ${scaledDivisor}`,
            `å–è¢«é™¤æ•°æ•´æ•°éƒ¨åˆ†${currentNum}ï¼ˆå‰${digitIndex}ä½ï¼‰Ã· ${scaledDivisor}ï¼Œå•†ä¸º${firstDigit}`,
            `${firstDigit}Ã—${scaledDivisor}=${firstProduct}ï¼Œ${currentNum}-${firstProduct}=${remainder}ï¼ˆä½™æ•°ï¼‰`,
          ],
        });

        // åç»­è®¡ç®—é€»è¾‘ä¸å˜ï¼ˆä»…å°† divisor æ›¿æ¢ä¸º scaledDivisorï¼‰
        while (
          (digitIndex < totalDigits || remainder !== 0) &&
          decimalCount <= maxDecimal
        ) {
          if (digitIndex >= intDigits.length && !hasDecimal) {
            quotientDigits.push(".");
            hasDecimal = true;
          }

          let currentDigit = 0;
          let isOriginalDigit = false;
          if (digitIndex < intDigits.length) {
            currentDigit = intDigits[digitIndex];
            isOriginalDigit = true;
            digitIndex++;
          } else if (digitIndex - intDigits.length < decDigits.length) {
            currentDigit = decDigits[digitIndex - intDigits.length];
            isOriginalDigit = true;
            digitIndex++;
          } else {
            currentDigit = 0;
            isOriginalDigit = false;
            decimalCount++;
          }

          const newMinuend = remainder * 10 + currentDigit;
          const digit =
            newMinuend >= scaledDivisor
              ? Math.floor(newMinuend / scaledDivisor)
              : 0;
          quotientDigits.push(digit);

          const product = digit * scaledDivisor;
          const newRemainder = newMinuend - product;

          const explanation = [];
          if (isOriginalDigit) {
            explanation.push(
              remainder === 0
                ? `ä½™æ•°ä¸º0ï¼Œè½ä¸‹è¢«é™¤æ•°çš„ä¸‹ä¸€ä½${currentDigit}ï¼Œå¾—åˆ°${newMinuend}`
                : `${remainder}åé¢è½ä¸‹è¢«é™¤æ•°çš„ä¸‹ä¸€ä½${currentDigit}ï¼Œå¾—åˆ°${newMinuend}`
            );
          } else {
            explanation.push(`${remainder}ä¸å¤Ÿé™¤ï¼Œè¡¥0å¾—åˆ°${newMinuend}`);
          }
          if (newMinuend < scaledDivisor) {
            explanation.push(`${newMinuend}<${scaledDivisor}ï¼Œå•†è¡¥0`);
          } else {
            explanation.push(
              `${newMinuend}Ã·${scaledDivisor}=${digit}ï¼ˆ${scaledDivisor}Ã—${digit}=${product}ï¼‰`
            );
          }
          explanation.push(`${digit}Ã—${scaledDivisor}=${product}`);
          explanation.push(`${newMinuend}-${product}=${newRemainder}ï¼ˆä½™æ•°ï¼‰`);

          steps.push({
            minuend: newMinuend,
            product: product,
            remainder: newRemainder,
            carryDigit: currentDigit,
            isOriginalDigit: isOriginalDigit,
            explanation: explanation,
          });

          remainder = newRemainder;
          if (remainder === 0 && digitIndex >= totalDigits) break;
        }

        let quotientStr = quotientDigits.join("");
        quotientStr = quotientStr.replace(/(\.\d*?)0+$/, "$1");
        quotientStr = quotientStr.replace(/\.$/, "");
        const quotient = parseFloat(quotientStr);

        if (remainder === 0) {
          steps[steps.length - 1].explanation.push(
            `ä½™æ•°ä¸º0ï¼Œè®¡ç®—ç»“æŸï¼Œå•†ä¸º${quotient}`
          );
        } else {
          steps[steps.length - 1].explanation.push(
            `ä¿ç•™${maxDecimal}ä½å°æ•°ï¼Œå•†ä¸º${quotient}`
          );
        }

        return { steps: steps, quotient: quotient };
      }
      // é™¤æ³•ç«–å¼æ¸²æŸ“
      function renderDivisionVertical(dividend, divisor, data) {
        const { steps, quotient } = data;
        const quotientStr = quotient.toString();
        const fullDividend = dividend.toString();
        const fullDivisor = divisor.toString();

        let html = `<div class="division-container inline-block">`;
        html += `<div class="mb-1 ml-[calc(50%+12px)]">${quotientStr}</div>`;
        html += `<div class="division-bar relative">`;
        html += `<div class="divisor">${fullDivisor}</div>`;

        html += `<div class="group-1">`;
        html += `<div class="my-1 item-1 full-dividend">${fullDividend}</div>`;
        html += `<div class="my-1 item-2">${steps[0].product}</div>`;
        html += `<div class="border-b-2 border-black my-1"></div>`;
        html += `</div>`;

        for (let i = 0; i < steps.length; i++) {
          const step = steps[i];
          const groupNum = i + 2;
          const remainderInt = Math.floor(step.remainder);
          let remainderStr = remainderInt.toString();

          if (i < steps.length - 1) {
            const nextStep = steps[i + 1];
            if (remainderInt === 0) {
              remainderStr = `<span class="carry-digit">${nextStep.carryDigit}</span>`;
            } else if (nextStep.isOriginalDigit) {
              remainderStr = `${remainderInt}<span class="carry-digit">${nextStep.carryDigit}</span>`;
            } else if (nextStep.carryDigit === 0) {
              remainderStr = `${remainderInt}<span class="carry-digit">0</span>`;
            }
          }

          html += `<div class="group-${groupNum}">`;
          html += `<div class="my-1 item-1">${remainderStr}</div>`;
          if (i < steps.length - 1) {
            html += `<div class="my-1 item-2">${steps[i + 1].product}</div>`;
            html += `<div class="border-b-2 border-black my-1"></div>`;
          } else if (step.remainder !== 0) {
            html += `<div class="border-b-2 border-black my-1"></div>`;
          }
          html += `</div>`;
        }

        html += `</div></div>`;
        return html;
      }
    </script>
  </body>
</html>


